<!DOCTYPE html>
<html>
  <head>
    <title>Camera demo</title>
    <meta charset="utf-8"></meta>
  </head>
  <body>
    <canvas id="canvas" style="width: 100%; height: 100vh; object-fit: contain; object-position: center;"></canvas>
    <video id="video" style="display: hidden; height: 0px; width: 100%;"></video>
    <script type="module">
      import { scanImage, createZbar } from "https://unpkg.com/zbar-wasi@1.0.7/dist/zbar-wasi.esm.js";
      const ZBAR = createZbar({ wasmpath: "https://unpkg.com/zbar-wasi@1.0.7/dist/zbar.wasm" });
      const domCanvas = document.getElementById("canvas");
      const domVideo = document.getElementById("video");
      const ctx = domCanvas.getContext("2d", { alpha: false });
      
      let renderLoopId;
      const renderLoop = () => {
        if (renderLoopId) {
          cancelAnimationFrame(renderLoopId);
        }
        ctx.drawImage(domVideo, 0, 0, domCanvas.width, domCanvas.height);
        const imageData = ctx.getImageData(0, 0, domCanvas.width, domCanvas.height);
        const results = scanImage(imageData);
        if (results.length > 0) alert("Barcodes: " + results.join(","));
        renderLoopId = requestAnimationFrame(renderLoop);
      };

      const hookCamera = async (fn) => {
        let srcCamera;
        try {
          srcCamera = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }});
        } catch (err) {
          alert("You need to give access to your camera from your browser");
          return;
        }
 
        domVideo.srcObject = srcCamera;
        domVideo.play();
        
        domVideo.addEventListener("loadeddata", () => {
          const mediatrack = srcCamera.getVideoTracks()[0];
          const { width, height } = mediatrack.getSettings();

          domCanvas.width = width;
          domCanvas.height = height;
          fn();
        });
      };
      hookCamera(renderLoop);
    </script>
  </body>
</html>
